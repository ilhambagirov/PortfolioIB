@model Blog
@{
    ViewData["Title"] = "Details";

    IEnumerable<BlogComment> GetComments(BlogComment parent)
    {
        if (parent.ParentId != null)
        {
            yield return parent;
        }

        foreach (var comment in parent.Children.SelectMany(c => GetComments(c)))
        {
            yield return comment;
        }
    }
}

<div class="tab-content">
    <div class="inside-sec blog">
        <!-- BIO AND SKILLS -->
        <h5 class="tittle">BLOG POST</h5>

        <!-- Blog -->
        <article class="blog-post width-100 padding-25">
            <div class="post-img">
                <img src="~/uploads/images/@Model.ImagePath" alt="">
                <span class="date-in">@Model.CreatedDate.ToString("dd MMM")</span>
            </div>

            <!-- BLOG DETAIL -->
            <h4 class="font-normal">@Model.BlogName</h4>
            <span class="post-bt">by <span class="text-color-primary">@Model.CreatedByUser.UserName</span></span>
            <ul class="post-info">
                @*<li> <i class="fa fa-comments-o"></i>97 </li>
                    <li> <i class="fa fa-eye"></i>565 </li>*@
                <li> <i class="fa fa-bookmark-o"></i>@Model.BlogType </li>
                <li>  </li>
            </ul>
            @Html.Raw(Model.Description)
            <div class="auther-name text-center margin-top-50">
                <h6 class="font-12px margin-top-20 margin-bottom-10">WHITE SHADOW WALKER</h6>
                <span class="font-16px font-crimson font-italic">Writer/Personal blog</span>
            </div>
            <div class="next-prev">
                <div class="row">
                    <div class="col-md-6 text-left"><a href="#." class="font-16px font-crimson text-uppercase"><i class="fa fa-long-arrow-left margin-right-15"></i> PREVIOUS Article</a></div>
                    <div class="col-md-6 text-right"><a href="#." class="font-16px font-crimson text-uppercase">Next Article<i class="fa fa-long-arrow-right margin-left-15"></i></a></div>
                </div>
            </div>


            <div class="comments">
                @if (!User.Identity.IsAuthenticated)
                {
                    <p>Please sign in for posting comments</p>
                }
                else
                {

                }
                <!-- Main Heading -->
                <div class="heading-side-bar margin-bottom-50 margin-top-100">
                    <h4>Comment (37)</h4>
                </div>
                <ul>

                    <!-- Comments -->
                    @foreach (var item in Model.BlogComments.Where(c => c.ParentId == null))
                    {
                        <li class="comment margin-bottom-30" id="c-@item.Id" data-user-id="@item.Id">
                            <div class="media">
                                <div class="media-left">
                                    <div class="avatar"><img src="~/uploads/images/avatar-1.jpg" alt=""></div>
                                </div>
                                <div class="media-body">
                                    <div class="a-com">
                                        <span class="a-name text-color-primary"><b>@item.CreatedByUser?.UserName</b> </span><span class="date">@item.CreatedDate.ToString("dd MMM")</span>
                                        <p class="margin-top-20">
                                            @item.Comment
                                        </p>
                                        <a class="btn btn-link text-right btn-reply"> REPLY <i class="fa fa-reply"></i></a>
                                    </div>
                                </div>
                            </div>
                        </li>
                        @foreach (var subitem in GetComments(item))
                        {
                            <li class="comment com-reply" id="c-@subitem.Id" data-user-id="@subitem.Id">
                                <div class="media">
                                    <div class="media-left">
                                        <div class="avatar"><img src="~/uploads/images/avatar-2.jpg" alt=""></div>
                                    </div>
                                    <div class="media-body">
                                        <div class="a-com">
                                            <span class="a-name ">@subitem.CreatedByUser.UserName </span><span class="date">@subitem.CreatedDate.ToString("dd MMM")</span>
                                            <p class="margin-top-20">
                                                @@@subitem.Parent.CreatedByUser.UserName  @subitem.Comment
                                            </p>
                                            @*<a class="btn btn-link text-right btn-reply"> REPLY <i class="fa fa-reply"></i></a>*@
                                        </div>
                                    </div>
                                </div>
                            </li>
                        }
                    }
                    @* <li class="text-center more-comments"><a href="#.">MORE COMMENT <i class="fa fa-angle-down"></i></a></li>*@
                </ul>
                <!-- Comments Form -->
                <div class="comment-form">
                    <!-- Main Heading -->

                    <form method="post" id="postcomment">
                        <div id="replytocomment">
                        </div>
                        @if (!User.Identity.IsAuthenticated)
                        {
                            <textarea id="signinplease" placeholder="YOUR MESSAGE"></textarea>
                        }
                        else
                        {
                            <input type="hidden" name="postId" value="@Model.Id" />
                            <textarea name="comment"
                                      placeholder="YOUR MESSAGE"></textarea>

                        }
                        <button type="submit" class="btn btn-dark">POST COMMENT </button>
                    </form>
                </div>
            </div>
        </article>
    </div>
</div>

@section addcss{
    <style>
        #replytocomment:not(:empty) {
            border: 1px solid #e1e1e1;
            max-width: 100%;
            color: #999;
            padding: 20px 20px;
            position: relative;
        }

        #replytocomment .comment {
            margin: 0 !important;
        }

        #replytocomment .btn-reply {
            display: none;
        }

        #replytocomment .close-comment {
            color: red !important;
            position: absolute;
            font-size: 3.2rem !important;
            top: -7px;
            right: -2px;
            max-width: 20px;
        }
    </style>
}

@section addjs{
    <script>
        $(document).ready(function () {
            $('#signinplease').focus(function (e) {
                console.log(e.currentTarget)
                setTimeout("window.location.pathname = \"signin.html\";", 0);
            })

            $('#postcomment').submit(function (e) {
                e.preventDefault();

                var formData = new FormData(e.currentTarget);

                var touserid = $('#replytocomment li').data("userId");

                if (touserid != undefined) {
                    formData.set("userId",touserid)
                }

                $.ajax({
                    url: '@Url.Action("Comment")',
                    type:'Post',
                    contentType: false,
                    processData: false,
                    data: formData,
                    dataType:'json',
                    success: function (response) {
                        if (response.error == true) {
                            console.log("okaydir")
                        }

                    },
                    error: function (response) {
                        if (response.statusText ==='parsererror') {
                            if (touserid != undefined) {
                                $(response.responseText).insertAfter(`#c-${touserid}`);
                                $('#replytocomment').html('');
                                e.currentTarget.reset();
                            }
                            else {
                                $('div.comments ul').append($(response.responseText))
                            }
                        }
                    }

                }
                )
            })

            $('.btn-reply').click(function (e) {
                e.preventDefault();

                $('#replytocomment').html('<a class="close-comment" href="javascript:close()">&times;</a>').append($(e.currentTarget).closest('.comment').clone())
            })
        })

        function close() {
            $('#replytocomment').html('')
        }
    </script>
}

